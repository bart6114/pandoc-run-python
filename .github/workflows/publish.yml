name: Publish Python ðŸ distributions ðŸ“¦ to PyPI and TestPyPI
on:
  push:
    branches:
      - "main"

jobs:
  tag-new-version:
    name: auto-tag commit
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          ref: ${{ github.head_ref }} # checkout the correct branch name
          fetch-depth: 0 # fetch the whole repo history

      - name: Git Version
        uses: codacy/git-version@2.2.0
        id: git-version
        with:
          release-branch: main

      - name: Create tag
        uses: actions/github-script@v3
        with:
          github-token: ${{ github.token }}
          script: |
            github.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: "refs/tags/${{ steps.git-version.outputs.version}}",
              sha: context.sha
            })

  build-n-publish:
    needs: tag-new-version
    name: Build and publish Python ðŸ distributions ðŸ“¦ to PyPI and TestPyPI
    runs-on: ubuntu-18.04
    env:
      POETRY_VERSION: 1.1.6
    steps:
      - uses: actions/checkout@master
      - name: Set up Python 3.7
        uses: actions/setup-python@v1
        with:
          python-version: 3.8
      - name: install pandoc
        run: >
          wget https://github.com/jgm/pandoc/releases/download/2.13/pandoc-2.13-1-amd64.deb &&
          sudo dpkg -i pandoc-2.13-1-amd64.deb

      - name: use poetry
        uses: abatilo/actions-poetry@v2.0.0
        with:
          poetry-version: ${{ env.POETRY_VERSION }}
      - name: init
        run: poetry install
      - name: build plugin
        run: pip install poetry-dynamic-versioning
      - name: run tests
        run: poetry run pytest --cov=pandoc_run_python tests/
      - name: build
        run: poetry build
      - name: Publish distribution ðŸ“¦ to Test PyPI
        uses: pypa/gh-action-pypi-publish@master
        with:
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository_url: https://test.pypi.org/legacy/
      - name: Publish distribution ðŸ“¦ to PyPI
        if: startsWith(github.ref, 'refs/tags')
        uses: pypa/gh-action-pypi-publish@master
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
